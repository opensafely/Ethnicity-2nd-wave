----------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/lsh152058/Documents/GitHub/Ethnicity-2nd-wave/logs/01_eth_cr_analysis_dataset.log
  log type:  text
 opened on:   6 Jan 2021, 19:05:00

. 
. clear

. import delimited ./output/input.csv
(80 vars, 100,000 obs)

. 
. global outcomes "tested positivetest icu hes onscoviddeath ons_noncoviddeath onsdeath"

. 
. ****************************
. *  Create required cohort  *
. ****************************
. 
. /* DROP ALL KIDS */
. noi di "DROPPING AGE<18:" 
DROPPING AGE<18:

. drop if age<18
(21,181 observations deleted)

. safecount
  78,819

. 
. * Age: Exclude those with implausible ages
. cap assert age<.

. noi di "DROPPING AGE<105:" 
DROPPING AGE<105:

. drop if age>105
(16 observations deleted)

. safecount
  78,803

. 
. * Sex: Exclude categories other than M and F
. cap assert inlist(sex, "M", "F", "I", "U")

. noi di "DROPPING GENDER NOT M/F:" 
DROPPING GENDER NOT M/F:

. drop if inlist(sex, "I", "U")
(0 observations deleted)

. 
. gen male = 1 if sex == "M"
(40,421 missing values generated)

. replace male = 0 if sex == "F"
(40,421 real changes made)

. label define male 0"Female" 1"Male"

. label values male male

. safetab male

       male |      Freq.     Percent        Cum.
------------+-----------------------------------
     Female |     40,421       51.29       51.29
       Male |     38,382       48.71      100.00
------------+-----------------------------------
      Total |     78,803      100.00

. safecount
  78,803

. 
. /*  IMD  */
. * Group into 5 groups
. rename imd imd_o

. egen imd = cut(imd_o), group(5) icodes

. 
. * add one to create groups 1 - 5 
. replace imd = imd + 1
(78,803 real changes made)

. 
. * - 1 is missing, should be excluded from population 
. replace imd = .u if imd_o == -1
(0 real changes made)

. drop imd_o

. 
. * Reverse the order (so high is more deprived)
. recode imd 5 = 1 4 = 2 3 = 3 2 = 4 1 = 5 .u = .u
(imd: 78803 changes made)

. 
. label define imd 1 "1 least deprived" 2 "2" 3 "3" 4 "4" 5 "5 most deprived" .u "Unknown"

. label values imd imd 

. safetab imd, m

             imd |      Freq.     Percent        Cum.
-----------------+-----------------------------------
1 least deprived |     54,951       69.73       69.73
               4 |     15,936       20.22       89.95
 5 most deprived |      7,916       10.05      100.00
-----------------+-----------------------------------
           Total |     78,803      100.00

. 
. drop if imd==.u
(0 observations deleted)

. safecount
  78,803

. 
. 
. * Create restricted cubic splines for age
. mkspline age = age, cubic nknots(4)

. 
. *Start dates
. gen index                       = "01/02/2020"

. 
. * Date of cohort entry, 1 Feb 2020
. gen indexdate = date(index, "DMY")

. format indexdate %d

. 
. 
. *******************************************************************************
. 
. 
. 
. /* CREATE VARIABLES===========================================================*/
. 
. /* OUTCOME AND SURVIVAL TIME==================================================*/
. 
. stop
command stop is unrecognized
r(199);

end of do-file

r(199);

. tab icu_date_admitted

icu_date_ad |
     mitted |      Freq.     Percent        Cum.
------------+-----------------------------------
 2020-09-01 |          1        0.01        0.01
 2020-09-16 |          1        0.01        0.01
 2020-09-21 |          1        0.01        0.02
 2020-09-22 |          1        0.01        0.03
 2020-09-26 |          1        0.01        0.03
 2020-10-02 |          1        0.01        0.04
 2020-10-03 |          1        0.01        0.04
 2020-10-04 |          1        0.01        0.05
 2020-10-05 |          4        0.03        0.08
 2020-10-08 |          1        0.01        0.08
 2020-10-09 |          2        0.01        0.09
 2020-10-10 |          1        0.01        0.10
 2020-10-11 |          1        0.01        0.11
 2020-10-12 |          4        0.03        0.13
 2020-10-14 |          2        0.01        0.15
 2020-10-15 |          3        0.02        0.16
 2020-10-16 |          2        0.01        0.18
 2020-10-17 |          3        0.02        0.20
 2020-10-18 |          2        0.01        0.21
 2020-10-19 |          5        0.03        0.24
 2020-10-20 |          1        0.01        0.25
 2020-10-21 |          1        0.01        0.25
 2020-10-22 |          4        0.03        0.28
 2020-10-23 |          2        0.01        0.29
 2020-10-24 |          4        0.03        0.32
 2020-10-25 |          1        0.01        0.32
 2020-10-26 |          3        0.02        0.34
 2020-10-27 |          3        0.02        0.36
 2020-10-28 |          4        0.03        0.38
 2020-10-30 |          6        0.04        0.42
 2020-10-31 |          6        0.04        0.46
 2020-11-01 |          6        0.04        0.50
 2020-11-02 |          9        0.06        0.56
 2020-11-03 |          9        0.06        0.61
 2020-11-04 |          8        0.05        0.66
 2020-11-05 |          4        0.03        0.69
 2020-11-06 |         17        0.11        0.80
 2020-11-07 |          9        0.06        0.85
 2020-11-08 |         18        0.11        0.97
 2020-11-09 |         13        0.08        1.05
 2020-11-10 |         10        0.06        1.11
 2020-11-11 |         21        0.13        1.24
 2020-11-12 |          9        0.06        1.30
 2020-11-13 |         15        0.09        1.39
 2020-11-14 |         17        0.11        1.50
 2020-11-15 |         21        0.13        1.63
 2020-11-16 |         17        0.11        1.74
 2020-11-17 |         38        0.24        1.98
 2020-11-18 |         25        0.16        2.14
 2020-11-19 |         29        0.18        2.32
 2020-11-20 |         33        0.21        2.53
 2020-11-21 |         33        0.21        2.74
 2020-11-22 |         40        0.25        2.99
 2020-11-23 |         39        0.25        3.24
 2020-11-24 |         40        0.25        3.49
 2020-11-25 |         44        0.28        3.77
 2020-11-26 |         50        0.32        4.08
 2020-11-27 |         45        0.28        4.37
 2020-11-28 |         53        0.33        4.70
 2020-11-29 |         67        0.42        5.12
 2020-11-30 |         73        0.46        5.59
 2020-12-01 |         65        0.41        6.00
 2020-12-02 |         70        0.44        6.44
 2020-12-03 |         74        0.47        6.90
 2020-12-04 |         89        0.56        7.47
 2020-12-05 |        110        0.69        8.16
 2020-12-06 |        114        0.72        8.88
 2020-12-07 |        116        0.73        9.61
 2020-12-08 |        114        0.72       10.33
 2020-12-09 |        141        0.89       11.22
 2020-12-10 |        120        0.76       11.98
 2020-12-11 |        178        1.12       13.10
 2020-12-12 |        182        1.15       14.25
 2020-12-13 |        174        1.10       15.35
 2020-12-14 |        176        1.11       16.46
 2020-12-15 |        194        1.22       17.68
 2020-12-16 |        238        1.50       19.19
 2020-12-17 |        243        1.53       20.72
 2020-12-18 |        256        1.62       22.34
 2020-12-19 |        303        1.91       24.25
 2020-12-20 |        300        1.89       26.14
 2020-12-21 |        337        2.13       28.27
 2020-12-22 |        384        2.42       30.69
 2020-12-23 |        395        2.49       33.18
 2020-12-24 |        372        2.35       35.53
 2020-12-25 |        450        2.84       38.37
 2020-12-26 |        526        3.32       41.69
 2020-12-27 |        533        3.36       45.06
 2020-12-28 |        628        3.96       49.02
 2020-12-29 |        663        4.18       53.20
 2020-12-30 |        668        4.22       57.42
 2020-12-31 |        741        4.68       62.10
 2021-01-01 |        807        5.09       67.19
 2021-01-02 |        834        5.26       72.45
 2021-01-03 |        889        5.61       78.06
 2021-01-04 |      1,027        6.48       84.54
 2021-01-05 |      1,221        7.71       92.25
 2021-01-06 |      1,228        7.75      100.00
------------+-----------------------------------
      Total |     15,845      100.00

. do "/var/folders/jg/zvg1wn090ps86p3lwtn901140000gn/T//SD63054.000000"

. /****   Outcome definitions   ****/
. ren primary_care_suspect_case   suspected_date

. ren primary_care_case                   confirmed_date

. ren first_tested_for_covid              tested_date

. ren first_positive_test_date    positivetest_date

. ren a_e_consult_date                    ae_date

. ren icu_date_admitted                   icu_date

. ren died_date_cpns                              cpnsdeath_date

. ren died_date_ons                               onsdeath_date

. ren covid_admission_date                hes_date

. 
. * Date of Covid death in ONS
. gen onscoviddeath_date = onsdeath_date if died_ons_covid_flag_any == 1
(75,689 missing values generated)

. gen onsconfirmeddeath_date = onsdeath_date if died_ons_confirmedcovid_flag_any ==1
(75,649 missing values generated)

. gen onssuspecteddeath_date = onsdeath_date if died_ons_suspectedcovid_flag_any ==1
(75,707 missing values generated)

. 
. * Date of non-COVID death in ONS 
. * If missing date of death resulting died_date will also be missing
. gen ons_noncoviddeath_date = onsdeath_date if died_ons_covid_flag_any != 1
(66,182 missing values generated)

. 
. 
. /* CONVERT STRINGS TO DATE FOR OUTCOME VARIABLES =============================*/
. * Recode to dates from the strings 
. *gen dummy date for infected and replace later on
. 
. foreach var of global outcomes {
  2.         confirm string variable `var'_date
  3.         rename `var'_date `var'_dstr
  4.         gen `var'_date = date(`var'_dstr, "YMD")
  5.         drop `var'_dstr
  6.         format `var'_date %td 
  7. 
. }
(62,917 missing values generated)
(63,095 missing values generated)
(62,958 missing values generated)
(59,125 missing values generated)
(75,689 missing values generated)
(66,182 missing values generated)
(63,068 missing values generated)

. 
end of do-file

